name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€
on: [push]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  run-syntax-check:
    runs-on: ubuntu-latest
    container: php:8.3-fpm
    steps:
      - uses: actions/checkout@v3
      - name: åŸ·è¡Œèªæ³•æª¢æŸ¥
        run: |
          find ./tests -name '*.php' -print0 | xargs -0 -n1 php -l

  PHP-Env-Install:
    runs-on: ubuntu-latest
    needs: run-syntax-check
    container:
      image: php:8.3-fpm
    steps:
      - name: å®‰è£ä¾è³´
        run: |
          apt-get update && apt-get install -y \
          libzip-dev \
          libonig-dev \
          build-essential \
          libpng-dev \
          libjpeg62-turbo-dev \
          libfreetype6-dev \
          locales \
          zip \
          jpegoptim optipng pngquant gifsicle \
          vim \
          unzip \
          git \
          curl \
          default-mysql-client
      - name: å®‰è£ PHP æ“´å±•
        run: |
          docker-php-ext-install pdo_mysql mbstring zip exif pcntl
          docker-php-ext-configure gd --with-jpeg=/usr/include/ --with-freetype=/usr/include/
          docker-php-ext-install gd
      - name: å®‰è£ Xdebug
        run: |
          pecl install xdebug
          docker-php-ext-enable xdebug
      - name: å®‰è£ composer
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php
          php -r "unlink('composer-setup.php');"
          mv composer.phar /usr/local/bin/composer
      - uses: actions/checkout@v3
      - name: ä½¿ç”¨ composer å®‰è£å¥—ä»¶
        run: |
          composer install
  Database-create:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8-oracle
        platform: linux/amd64
        environment:
          MYSQL_DATABASE: docker
          MYSQL_ROOT_PASSWORD: 1Qaz2Wsx
        ports:
          - "3306"
  Start-test:
    runs-on: ubuntu-latest
    needs: Database-create
    container:
      image: php:8.3-fpm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Copy .env
        run: cp .env.example .env

      - name: Generate Key
        run: php artisan key:generate

      - name: Migrate Database
        run: php artisan migrate
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: docker
          DB_PASSWORD: 1Qaz2Wsx
      - name: åŸ·è¡Œæ¸¬è©¦
        run: |
          XDEBUG_MODE=coverage composer test
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: docker
          DB_PASSWORD: 1Qaz2Wsx
      - name: ä¸Šå‚³æ¸¬è©¦å ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: html-coverage
